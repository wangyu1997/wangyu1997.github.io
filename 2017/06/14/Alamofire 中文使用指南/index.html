<!DOCTYPE html>
<html lang="zh">
    <head>
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.3 -->

    <!-- Title -->
    
    <title>
        
            Alamofire 中文使用指南 | 
        
        人不如故
    </title>

    <!-- Meta & Info -->
    <meta charset="utf-8">

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
        <link rel="dns-prefetch" href="https://hm.baidu.com"/>
    
    
        <link rel="dns-prefetch" href="https://www.google-analytics.com"/>
    
    
        <link rel="dns-prefetch" href="https://busuanzi.ibruce.info"/>
    

    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#000">
    <meta name="author" content="人不如故">
    <meta name="description" content="世间一场大梦，人生几度秋凉。">
    <meta name="keywords" content="null,Alamofire">

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="人不如故">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="https://wangyu1997.github.io">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Alamofire 中文使用指南 | 人不如故">
    <meta property="og:description" content="世间一场大梦，人生几度秋凉。">
    <meta property="og:article:tag" content="Alamofire"> 

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->
    <!-- Import CSS & jQuery -->
    
        <link rel="stylesheet" href="/css/material.min.css">
        <link rel="stylesheet" href="/css/style.min.css">
        <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #000;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #000 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #000 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #000 !important;
  }

  .toTop {
    background: #000 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #000;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #000;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #000;
  }

  .post-toc a:hover {
    color: #000;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-image: url(/img/bg.jpg);
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


        <script src="/js/jquery.min.js"></script>
        <script src="/js/queue.js"></script>
    

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    
    <!-- Baidu Analytics -->
    <script>
        var _hmt = _hmt || [];
        (function() {var hm = document.createElement('script');
        hm.src = 'https://hm.baidu.com/hm.js?0c1235d6c5795e257894fa96152e0154';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(hm, s);
        })();
    </script>
    

    
    <!-- Google Analytics -->
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-99567775-1', 'auto');ga('send', 'pageview');
    </script>
    


    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
<link rel="stylesheet" href="/css/prism-dark.css" type="text/css"></head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top">
                        <!---->
                    </div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#要求"><span class="post-toc-number">1.</span> <span class="post-toc-text">要求</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#升级的好处"><span class="post-toc-number">2.</span> <span class="post-toc-text">升级的好处</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#API-破坏性的修改"><span class="post-toc-number">3.</span> <span class="post-toc-text">API 破坏性的修改</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#命名空间的修改"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">命名空间的修改</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#生成请求"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">生成请求</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Data-Request-Simple-with-URL-string"><span class="post-toc-number">3.2.1.</span> <span class="post-toc-text">Data Request - Simple with URL string</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Data-Request-Complex-with-URL-string"><span class="post-toc-number">3.2.2.</span> <span class="post-toc-text">Data Request - Complex with URL string</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Download-Request-Simple-With-URL-string"><span class="post-toc-number">3.2.3.</span> <span class="post-toc-text">Download Request - Simple With URL string</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Download-Request-Simple-With-URLRequest"><span class="post-toc-number">3.2.4.</span> <span class="post-toc-text">Download Request - Simple With URLRequest</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Download-Request-Complex-With-URL-String"><span class="post-toc-number">3.2.5.</span> <span class="post-toc-text">Download Request - Complex With URL String</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Upload-Request-Simple-With-URL-string"><span class="post-toc-number">3.2.6.</span> <span class="post-toc-text">Upload Request - Simple With URL string</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Upload-Request-Simple-With-URLRequest"><span class="post-toc-number">3.2.7.</span> <span class="post-toc-text">Upload Request - Simple With URLRequest</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Upload-Request-Complex-With-URL-string"><span class="post-toc-number">3.2.8.</span> <span class="post-toc-text">Upload Request - Complex With URL string</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#URLStringConvertible-协议"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">URLStringConvertible 协议</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#URLConvertible"><span class="post-toc-number">3.3.1.</span> <span class="post-toc-text">URLConvertible</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#URLRequest-Conformance"><span class="post-toc-number">3.3.2.</span> <span class="post-toc-text">URLRequest Conformance</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#URLRequestConvertible"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">URLRequestConvertible</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#新功能"><span class="post-toc-number">4.</span> <span class="post-toc-text">新功能</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Request-Adapter-请求适配器"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">Request Adapter (请求适配器)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Request-Retrier-请求重连"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">Request Retrier (请求重连)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Task-Metrics"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">Task Metrics</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Updated-Features-更新的功能"><span class="post-toc-number">5.</span> <span class="post-toc-text">Updated Features 更新的功能</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Errors-异常"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">Errors 异常</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Parameter-Encoding-Protocol-参数编码的协议"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">Parameter Encoding Protocol 参数编码的协议</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#URL-Encoding-参数编码"><span class="post-toc-number">5.2.1.</span> <span class="post-toc-text">URL Encoding (参数编码)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#JSON-Encoding-JSON-编码"><span class="post-toc-number">5.2.2.</span> <span class="post-toc-text">JSON Encoding (JSON 编码)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Property-List-Encoding-属性列表编码"><span class="post-toc-number">5.2.3.</span> <span class="post-toc-text">Property List Encoding (属性列表编码)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Custom-Encoding-自定义编码"><span class="post-toc-number">5.2.4.</span> <span class="post-toc-text">Custom Encoding 自定义编码</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Request-Subclasses-Request-的子类"><span class="post-toc-number">5.3.</span> <span class="post-toc-text">Request Subclasses (Request 的子类)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Download-and-Upload-Progress-下载和上传你进度"><span class="post-toc-number">5.3.1.</span> <span class="post-toc-text">Download and Upload Progress (下载和上传你进度)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Download-File-Destinations-文件下载地址"><span class="post-toc-number">5.3.2.</span> <span class="post-toc-text">Download File Destinations 文件下载地址</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Download-Options-下载选项"><span class="post-toc-number">5.3.3.</span> <span class="post-toc-text">Download Options 下载选项</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Response-Validation-数据验证"><span class="post-toc-number">5.4.</span> <span class="post-toc-text">Response Validation 数据验证</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Data-Request-数据请求"><span class="post-toc-number">5.4.1.</span> <span class="post-toc-text">Data Request 数据请求</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Download-Request-下载请求"><span class="post-toc-number">5.4.2.</span> <span class="post-toc-text">Download Request 下载请求</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Response-Serializers-返回数据序列化"><span class="post-toc-number">5.5.</span> <span class="post-toc-text">Response Serializers 返回数据序列化</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Default-Data-Response"><span class="post-toc-number">5.5.1.</span> <span class="post-toc-text">Default Data Response</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Data-Response"><span class="post-toc-number">5.5.2.</span> <span class="post-toc-text">Data Response</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Default-Download-Response-默认下载请求的-Response-类型"><span class="post-toc-number">5.5.3.</span> <span class="post-toc-text">Default Download Response 默认下载请求的 Response 类型</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Download-Response"><span class="post-toc-number">5.5.4.</span> <span class="post-toc-text">Download Response</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Custom-Response-Serializers-自定义序列化"><span class="post-toc-number">5.5.5.</span> <span class="post-toc-text">Custom Response Serializers 自定义序列化</span></a></li></ol></li></ol></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        <!-- Custom Thumbnail -->
        <div class="post_thumbnail-custom mdl-card__media mdl-color-text--grey-50" style="background-image:url(http://oq5d32gij.bkt.clouddn.com/14952159759791.jpg)">
    
            <p class="article-headline-p">
                Alamofire 中文使用指南
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>人不如故</strong>
        <span>6月 14, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    
        <button id="article-functions-qrcode-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
            <i class="material-icons" role="presentation">devices other</i>
            <span class="visuallyhidden">devices other</span>
        </button>
        <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-qrcode-button">
            <li class="mdl-menu__item">在其它设备中阅读本文章</li>
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAAC0klEQVR42u3aUU5rMQwE0O5/07wFIPpm7KqU5NwvBOUmJ0hYHufxdeXzwMbGxsbGxsbGxv5I9iN+vv/W8+98f//zFX/66fN3FnvGxsbGPpr9n3/9T5HJpmerJCsWe8bGxsa+gJ1sOi8br6K2+8HGxsbGzpeZtQd5g/HakomNjY2NPWtL8qYiOVxsbGxs7H2o1LYcLT4fIbw1S8PGxsb+ePYsKvrdr98638bGxsb+YHb77K/15L/7vCGpd46NjY19KDsvDLNhbf6ZfA/DfWJjY2NfzN7E/UmU/xM7ioryoQI2Njb20ew2SJo1CTNqeygvyNKwsbGx/yw7L1TtyDYpkHlbMhswY2NjY9/Gbke/bWnZH9bL5tvY2NjYR7Dz+Cb5fhIttYHRZuSAjY2NfQN7FiTNCkk+VJhd6xlmadjY2Nh/lr0ZwbYLz97ZNj/Y2NjYt7HzApM3BvsxwKwhGd5UwsbGxj6CnS/Zjg3aCzftCDk/JmxsbOxT2e1QdtNOzKKl9giKDgwbGxv7IPbsGs2+tOTlM/8z/LgWNjY29gXspCAVV2Tikpav3o4KsLGxsW9jty3HJn5K3vCqn2JjY2Ofzc7bgFmg3253X7rqO6fY2NjYR7DbEtWGQZv4qR08YGNjY9/Jzl8xK2z5cbzqWg82Njb2zex2Q3mgn0dLyeHWoRg2Njb20exNMNQ2J3mDsYm6ig4MGxsb+yD2bJi639zwMmXbCGFjY2Nfw561H22rsClp7YgXGxsb+2x2+wyHrOVQoS1Xwzun2NjY2EewN1F+HgnNmpzNkHg46MXGxsb+s+x2yXxY2x5HPmBoP4+NjY19A7u9uDMLpGbH9KYsDRsbG/sydj5maItfHmb9QgHDxsbGPoK92eIslpqVQGxsbOzb2Hl8n48NVhsN1s0LITY2NvbZ7Fmgvw+A9sUs/zw2Njb2qex7HmxsbGxsbGxsbOyPef4BDgTilZkqfLIAAAAASUVORK5CYII=">
        </ul>
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/Alamofire/">Alamofire</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    
        
            <!-- Busuanzi Views -->
            <a class="post_share-link" href="#">
                <li class="mdl-menu__item">
                    <span id="busuanzi_container_page_pv">
                        <span id="busuanzi_value_page_pv"></span>&nbsp;浏览量
                    </span>
                </li>
            </a>
        
    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=Alamofire 中文使用指南&url=https://wangyu1997.github.io//2017/06/14/Alamofire 中文使用指南/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=Alamofire 中文使用指南&url=https://wangyu1997.github.io//2017/06/14/Alamofire 中文使用指南/index.html&via=人不如故" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=https://wangyu1997.github.io//2017/06/14/Alamofire 中文使用指南/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=https://wangyu1997.github.io//2017/06/14/Alamofire 中文使用指南/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=人不如故&title=Alamofire 中文使用指南&summary=世间一场大梦，人生几度秋凉。&pics=https://wangyu1997.github.io/img/favicon.png&url=https://wangyu1997.github.io/2017/06/14/Alamofire 中文使用指南/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
   
    
            <link rel="stylesheet" type="text/css" href="/assets/css/DPlayer.min.css"><script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><hr>
<p>Alamofire 4.0 是 Alamofire 最新的一个大版本更新, 一个基于 Swift 的 iOS, tvOS, macOS, watchOS 的 HTTP 网络库. 作为一个大版本更新, 就像语义上那样, 4.0 的 API 引入了一些破坏性修改. </p>
<p>这篇导引旨在帮助大家从 Alamofire 3.x 平滑过渡到最新版本, 同时也解释一下新的设计和结构, 以及功能上的更新.<br><a id="more"></a> </p>
<h2 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h2><ul>
<li><p>iOS 8.0+, macOS 10.10.0+, tvOS 9.0+ 以及 watchOS 2.0+ </p>
</li>
<li><p>Xcode 8.1+ </p>
</li>
<li><p>Swift 3.0+ </p>
</li>
</ul>
<p>那些想要在 iOS 8 或者 macOS 10.9 使用 Alamofire 的, 请使用 3.x 版本的最新 release(同时支持 Swift 2.2以及2.3) </p>
<h2 id="升级的好处"><a href="#升级的好处" class="headerlink" title="升级的好处"></a>升级的好处</h2><ul>
<li><strong>完美适配 Swift 3:</strong> 跟进了新的 <a href="https://swift.org/documentation/api-design-guidelines/" target="_blank" rel="external">API 设计规范</a>. </li>
</ul>
<ul>
<li><strong>新的错误处理系统:</strong> 根据提案 <a href="https://github.com/apple/swift-evolution/blob/master/proposals/0112-nserror-bridging.md" target="_blank" rel="external">SE-0112</a> 里的新模式, 新增了 <code>AFError</code> 类型. </li>
</ul>
<ul>
<li><p><strong>新的 <code>RequestAdapter</code> 协议:</strong> 可以在初始化 <code>Request</code> 的时候进行快速便捷的适配, 例如在请求头里加入 <code>Authorization</code></p>
</li>
<li><p><strong>新的 <code>RequestRetrier</code> 协议:</strong> 可以检测并且重试失败的 <code>Request</code>, 甚至可以自己根据一系列需求去构建一套验证的解决方案( OAuth1, OAuth2, xAuth, Basic Auth 之类的). </p>
</li>
<li><p><strong>新的 <code>Parameter Encoding</code> 协议:</strong> 取代掉之前的 <code>ParameterEncoding</code> 枚举, 允许你更简单的拓展和自定义, 并且在错误时抛出异常, 而不是简单的返回一个元组. </p>
</li>
<li><p><strong>新的请求类型:</strong> 包括 <code>DataRequest</code>, <code>DownloadRequest</code>, <code>UploadRequest</code> 和 <code>StreamRequest</code>, 实现了特定的进度, 验证和序列化的 API 以及各自的 <code>Request</code> 类型. </p>
</li>
<li><p><strong>新的进度 API:</strong> 包括 <code>downloadProgress</code> 和 <code>uploadProgress</code>, 支持 <code>progress</code> 和 <code>Int64</code> 类型, 并且会在指定的线程运行, 默认为主线程. </p>
</li>
<li><p><strong>更强大的数据验证:</strong> 在验证失败的时候, 包括 <code>data</code> 或者 <code>temporaryURL</code> 和 <code>destinationURL</code> 都可以使用内联的闭包去转化服务器返回的错误信息 </p>
</li>
<li><p><strong>新的下载地址处理:</strong> 你可以获得完整的控制权, 而不是像之前那样只是提供一个 <code>destinationURL</code>, 还得创建临时文件夹, 删掉之前的文件. </p>
</li>
<li><p><strong>新的 <code>Response</code> 类型:</strong> 统一 response 的 API, 并且为所有下载任务提供 <code>temporaryURL</code> 和 <code>downloadURL</code>, 以及其它新平台上的任务属性. </p>
</li>
</ul>
<h2 id="API-破坏性的修改"><a href="#API-破坏性的修改" class="headerlink" title="API 破坏性的修改"></a>API 破坏性的修改</h2><p>Alamofire 4 跟进了 Swift 3 里所有的修改, 包括 <a href="https://swift.org/documentation/api-design-guidelines/" target="_blank" rel="external">API 设计规范</a>. 因此, 几乎所有 Alamofire 的 API 都进行了一定程度的修改. 我们没办法把这些修改全部在文档里列出来, 所以我们会把最常用的那些 API 列出来, 然后告诉大家这些 API 进行了哪些修改, 而不是指望那些有时帮倒忙的编译错误提示. </p>
<h3 id="命名空间的修改"><a href="#命名空间的修改" class="headerlink" title="命名空间的修改"></a>命名空间的修改</h3><p>一些常用的类移到了全局命名空间成为一级类, 让他们更容易使用. </p>
<ul>
<li><p><code>Manager</code> 改为 <code>SessionManager</code></p>
</li>
<li><p><code>Request.TaskDelegate</code> 改为 <code>TaskDelegate</code></p>
</li>
<li><p><code>Request.DataTaskDelegate</code> 改为 <code>DataTaskDelegate</code></p>
</li>
<li><p><code>Request.DownloadTaskDelegate</code> 改为 <code>DownloadTaskDelegate</code></p>
</li>
<li><p><code>Request.UploadTaskDelegate</code> 改为 <code>UploadTaskDelegate</code></p>
</li>
</ul>
<p>我们也重新调整了文件结构和组织模式, 帮助更好的跟进代码. 我们希望这可以让更多用户去了解内部结构和 Alamofire 的具体实现. 只是就是力量. </p>
<h3 id="生成请求"><a href="#生成请求" class="headerlink" title="生成请求"></a>生成请求</h3><p>生成请求是 Alamofire 里最主要的操作, 这里有 3.x 以及 4 的等效代码对比. </p>
<h4 id="Data-Request-Simple-with-URL-string"><a href="#Data-Request-Simple-with-URL-string" class="headerlink" title="Data Request - Simple with URL string"></a>Data Request - Simple with URL string</h4><pre><code>// Alamofire 3
Alamofire.request(.GET, urlString).response { request, response, data, error in
    print(request)
    print(response)
    print(data)
    print(error)
}

// Alamofire 4
Alamofire.request(urlString).response { response in // 默认为 `.get` 方法
    debugPrint(response)
}
</code></pre><h4 id="Data-Request-Complex-with-URL-string"><a href="#Data-Request-Complex-with-URL-string" class="headerlink" title="Data Request - Complex with URL string"></a>Data Request - Complex with URL string</h4><pre><code>// Alamofire 3
let parameters: [String: AnyObject] = [&quot;foo&quot;: &quot;bar&quot;]

Alamofire.request(.GET, urlString, parameters: parameters, encoding: .JSON)
        .progress { bytesRead, totalBytesRead, totalBytesExpectedToRead in
                print(&quot;Bytes: \(bytesRead), Total Bytes: \(totalBytesRead), Total Bytes Expected: \(totalBytesExpectedToRead)&quot;)
        }
        .validate { request, response in
                // 自定义的校验闭包 (访问不到服务器返回的数据)
            return .success
        }
    .responseJSON { response in
                debugPrint(response)
        }

// Alamofire 4
let parameters: Parameters = [&quot;foo&quot;: &quot;bar&quot;]

Alamofire.request(urlString, method: .get, parameters: parameters, encoding: JSONEncoding.default)
        .downloadProgress(queue: DispatchQueue.global(qos: .utility)) { progress in
                print(&quot;进度: \(progress.fractionCompleted)&quot;)
        }
        .validate { request, response, data in
                // 自定义的校验闭包, 现在加上了 `data` 参数(允许你提前转换数据以便在必要时挖掘到错误信息)
            return .success
        }
    .responseJSON { response in
                debugPrint(response)
        }
</code></pre><h4 id="Download-Request-Simple-With-URL-string"><a href="#Download-Request-Simple-With-URL-string" class="headerlink" title="Download Request - Simple With URL string"></a>Download Request - Simple With URL string</h4><pre><code>// Alamofire 3
let destination = DownloadRequest.suggestedDownloadDestination()

Alamofire.download(.GET, urlString, destination: destination).response { request, response, data, error in
      // fileURL 在哪, 怎么获取?
    print(request)
    print(response)
    print(data)
    print(error)
}

// Alamofire 4
let destination = DownloadRequest.suggestedDownloadDestination()

Alamofire.download(urlString, to: destination).response { response in // 默认为 `.get` 方法
    print(response.request)
    print(response.response)
        print(response.temporaryURL)
        print(response.destinationURL)
    print(response.error)
}
</code></pre><h4 id="Download-Request-Simple-With-URLRequest"><a href="#Download-Request-Simple-With-URLRequest" class="headerlink" title="Download Request - Simple With URLRequest"></a>Download Request - Simple With URLRequest</h4><pre><code>// Alamofire 3
let destination = DownloadRequest.suggestedDownloadDestination()

Alamofire.download(urlRequest, destination: destination).validate().responseData { response in
      // fileURL 在哪里, 太难获取了
        debugPrint(response)
}

// Alamofire 4
Alamofire.download(urlRequest, to: destination).validate().responseData { response in
        debugPrint(response)
        print(response.temporaryURL)
        print(response.destinationURL)
}
</code></pre><h4 id="Download-Request-Complex-With-URL-String"><a href="#Download-Request-Complex-With-URL-String" class="headerlink" title="Download Request - Complex With URL String"></a>Download Request - Complex With URL String</h4><pre><code>// Alamofire 3
let fileURL: NSURL
let destination: Request.DownloadFileDestination = { _, _ in fileURL }
let parameters: [String: AnyObject] = [&quot;foo&quot;: &quot;bar&quot;]

Alamofire.download(.GET, urlString, parameters: parameters, encoding: .JSON, to: destination)
        .progress { bytesRead, totalBytesRead, totalBytesExpectedToRead in
                print(&quot;Bytes: \(bytesRead), Total Bytes: \(totalBytesRead), Total Bytes Expected: \(totalBytesExpectedToRead)&quot;)
        }
        .validate { request, response in
                // 自定义的校验实现(获取不到临时下载位置和目标下载位置)
            return .success
        }
        .responseJSON { response in
                print(fileURL) // 只有在闭包捕获了的情况才能获取到, 不够理想
                debugPrint(response)
        }

// Alamofire 4
let fileURL: URL
let destination: DownloadRequest.DownloadFileDestination = { _, _ in
        return (fileURL, [.createIntermediateDirectories, .removePreviousFile])
}
let parameters: Parameters = [&quot;foo&quot;: &quot;bar&quot;]

Alamofire.download(urlString, method: .get, parameters: parameters, encoding: JSONEncoding.default, to: destination)
        .downloadProgress(queue: DispatchQueue.global(qos: .utility)) { progress in
                print(&quot;进度: \(progress.fractionCompleted)&quot;)
        }
        .validate { request, response, temporaryURL, destinationURL in
                // 自定义的校验闭包, 现在包含了 fileURL (必要时可以获取到错误信息)
            return .success
        }
        .responseJSON { response in
                debugPrint(response)
                print(response.temporaryURL)
                print(response.destinationURL)
        }
</code></pre><h4 id="Upload-Request-Simple-With-URL-string"><a href="#Upload-Request-Simple-With-URL-string" class="headerlink" title="Upload Request - Simple With URL string"></a>Upload Request - Simple With URL string</h4><pre><code>// Alamofire 3
Alamofire.upload(.POST, urlString, data: data).response { request, response, data, error in
    print(request)
    print(response)
    print(data)
    print(error)
}

// Alamofire 4
Alamofire.upload(data, to: urlString).response { response in // 默认为 `.post` 方法
    debugPrint(response)
}
</code></pre><h4 id="Upload-Request-Simple-With-URLRequest"><a href="#Upload-Request-Simple-With-URLRequest" class="headerlink" title="Upload Request - Simple With URLRequest"></a>Upload Request - Simple With URLRequest</h4><pre><code>// Alamofire 3
Alamofire.upload(urlRequest, file: fileURL).validate().responseData { response in
        debugPrint(response)
}

// Alamofire 4
Alamofire.upload(fileURL, with: urlRequest).validate().responseData { response in
        debugPrint(response)
}
</code></pre><h4 id="Upload-Request-Complex-With-URL-string"><a href="#Upload-Request-Complex-With-URL-string" class="headerlink" title="Upload Request - Complex With URL string"></a>Upload Request - Complex With URL string</h4><pre><code>// Alamofire 3
Alamofire.upload(.PUT, urlString, file: fileURL)
        .progress { bytes, totalBytes, totalBytesExpected in
                // 这里的进度是上传还是下载的?
                print(&quot;Bytes: \(bytesRead), Total Bytes: \(totalBytesRead), Total Bytes Expected: \(totalBytesExpectedToRead)&quot;)
        }
        .validate { request, response in
                // 自定义的校验实现(获取不到服务端的数据)
            return .success
        }
        .responseJSON { response in
                debugPrint(response)
        }

// Alamofire 4
Alamofire.upload(fileURL, to: urlString, method: .put)
        .uploadProgress(queue: DispatchQueue.global(qos: .utility)) { progress in
                print(&quot;上传进度: \(progress.fractionCompleted)&quot;)
        }
        .downloadProgress { progress in // 默认在主队列调用
                print(&quot;下载进度: \(progress.fractionCompleted)&quot;)
        }
        .validate { request, response, data in
                // 自定义的校验闭包, 现在加上了 `data` 参数(允许你提前转换数据以便在必要时挖掘到错误信息)
            return .success
        }
    .responseJSON { response in
                debugPrint(response)
        }
</code></pre><p>就像你看到的, 有很多 API 破坏性的修改, 但常用的 API 还是沿用了原来的设计, 但现在能够通过一行代码去生成更多更复杂的请求, 保持秩序的同时更加简洁. </p>
<h3 id="URLStringConvertible-协议"><a href="#URLStringConvertible-协议" class="headerlink" title="URLStringConvertible 协议"></a>URLStringConvertible 协议</h3><p><code>URLStringConvertible</code> 协议有两个很小的改变. </p>
<h4 id="URLConvertible"><a href="#URLConvertible" class="headerlink" title="URLConvertible"></a>URLConvertible</h4><p>第一个没什么了不起的”大”改变就是 <code>URLStringConvertible</code> 已经被重命名为 <code>URLConvertible</code>. 在 3.x 里, <code>URLStringConvertible</code> 的定义是这样子的: </p>
<pre><code>public protocol URLStringConvertible {
    var URLString: String { get }
}
</code></pre><p>现在在 Alamofire 4 里, <code>URLConvertible</code> 协议是这样定义的: </p>
<pre><code>public protocol URLConvertible {
    func asURL() throws -&gt; URL
}
</code></pre><p>就像你看到的, <code>URLString</code> 属性完全去掉了, 然后换成了可能会抛出异常的 <code>asURL</code> 方法. 为了解释这样做的原因, 我们先回顾一下. </p>
<p>Alamofire 一个最最常见的问题就是用户忘了对 URL 进行百分号编码, 导致 Alamofire 崩溃掉. 直到现在, 我们(Alamofire 团队)的态度都是 Alamofire 就是这么设计的, 而你的 URL 必须遵守 <a href="https://tools.ietf.org/html/rfc2396" target="_blank" rel="external">RFC 2396 协议</a>. 但这对于社区来说并不那么好, 因为我们更希望 Alamofire 告诉我们的 URL 是不合法的而不是直接 crash 掉. </p>
<p>现在, 回到新的 <code>URLConvertible</code> 协议. Alamofire 之所以不能安全地处理不合规范的 URL 字符串, 事实上是因为 <code>URLStringConvertible</code> 安全性的缺失. Alamofire 不可能知道你是怎么造出一个不合法的 URL. 所以, 如果 <code>URL</code> 不能通通过 <code>URLConvertible</code> 被创建的话, 一个 <code>AFError.invalidURL</code> 的异常就会被抛出. </p>
<p>这个修改(以及其它很多修改都)可以让 Alamofire 安全地处理不合理的 URL, 并且会在回调里抛出异常. </p>
<h4 id="URLRequest-Conformance"><a href="#URLRequest-Conformance" class="headerlink" title="URLRequest Conformance"></a>URLRequest Conformance</h4><p><code>URLRequest</code> 不再遵守 <code>URLStringConvertible</code>, 现在是 <code>URLConvertible</code>. 但这也只是之前版本的一个延展而已, 并不那么重要. 不过这很可能会让 Alamofire 的 API 产生歧义. 因此, <code>URLRequest</code> 不再遵守 <code>URLStringConvertible</code>. </p>
<p>这意味着你不能在代码里像这样子做了: </p>
<pre><code>let urlRequest = URLRequest(url: URL(string: &quot;https://httpbin.org/get&quot;)!)
let urlString = urlRequest.urlString
</code></pre><p>在 Alamofire 4里, 你应该这么做: </p>
<pre><code>let urlRequest = URLRequest(url: URL(string: &quot;https://httpbin.org/get&quot;)!)
let urlString = urlRequest.url?.absoluteString
</code></pre><blockquote>
<p>查看 <a href="https://github.com/Alamofire/Alamofire/pull/1505" target="_blank" rel="external">PR-1505</a> 以获取更多信息. </p>
</blockquote>
<h3 id="URLRequestConvertible"><a href="#URLRequestConvertible" class="headerlink" title="URLRequestConvertible"></a>URLRequestConvertible</h3><p>在 3.x 里, <code>URLRequestConvertible</code> 也会产生相同的歧义问题, 之前的 <code>URLRequestConvertible</code> 是这么定义的: </p>
<pre><code>public protocol URLRequestConvertible {
    var URLRequest: URLRequest { get }
}
</code></pre><p>现在, 在 Alamofire 4 里, 变成了这样子: </p>
<pre><code>public protocol URLRequestConvertible {
    func asURLRequest() throws -&gt; URLRequest
}
</code></pre><p>就像看到的这样, <code>URLRequest</code> 属性被替换成了 <code>asURLRequest</code> 方法, 并且在生成 <code>URLRequest</code> 失败时会抛出异常. </p>
<p>这影响最大的可能是采用了 <code>Router</code> (路由)设计的你, 如果你用了 <code>Router</code>, 那你就不得不去改变, 但会变得更好! 你需要去实现 <code>asURLRequest</code> 方法, 在必要的时候会抛出异常. 你不再需要强制解包数据和参数, 或者在 do-catch 里构建一个 <code>ParameterEncoding</code>. 现在 <code>Router</code> 抛出的任何错误都可以由 Alamofire 帮你处理掉. </p>
<blockquote>
<p>查看 <a href="https://github.com/Alamofire/Alamofire/pull/1505" target="_blank" rel="external">PR-1505</a> 以获取更多信息. </p>
</blockquote>
<h2 id="新功能"><a href="#新功能" class="headerlink" title="新功能"></a>新功能</h2><h3 id="Request-Adapter-请求适配器"><a href="#Request-Adapter-请求适配器" class="headerlink" title="Request Adapter (请求适配器)"></a>Request Adapter (请求适配器)</h3><p><code>RequestAdapter</code> 协议是 Alamofire 4 里的全新功能. </p>
<pre><code>public protocol RequestAdapter {
    func adapt(_ urlRequest: URLRequest) throws -&gt; URLRequest
}
</code></pre><p>它可以让每一个 <code>SessionManager</code> 生成的 <code>Request</code> 都在生成之前被解析并且按照规则适配. 一个使用适配器很典型的场景就是给请求添加一个 <code>Authorization</code> 的请求头. </p>
<pre><code>class AccessTokenAdapter: RequestAdapter {
    private let accessToken: String

    init(accessToken: String) {
        self.accessToken = accessToken
    }

    func adapt(_ urlRequest: URLRequest) throws -&gt; URLRequest {
        var urlRequest = urlRequest

        if urlRequest.urlString.hasPrefix(&quot;https://httpbin.org&quot;) {
            urlRequest.setValue(&quot;Bearer &quot; + accessToken, forHTTPHeaderField: &quot;Authorization&quot;)
        }

        return urlRequest
    }
}

let sessionManager = SessionManager()
sessionManager.adapter = AccessTokenAdapter(accessToken: &quot;1234&quot;)

sessionManager.request(&quot;https://httpbin.org/get&quot;)
</code></pre><p>如果一个 <code>Error</code> 在适配过程中产生的话, 它会逐层抛出, 最后传递到 <code>Request</code> 的请求回调里. </p>
<blockquote>
<p>查看 <a href="https://github.com/Alamofire/Alamofire/pull/1450" target="_blank" rel="external">PR-1450</a> 获取更多信息. </p>
</blockquote>
<h3 id="Request-Retrier-请求重连"><a href="#Request-Retrier-请求重连" class="headerlink" title="Request Retrier (请求重连)"></a>Request Retrier (请求重连)</h3><p><code>RequestRetrier</code> 是 Alamofire 4 的另一个全新协议. </p>
<pre><code>public typealias RequestRetryCompletion = (_ shouldRetry: Bool, _ timeDelay: TimeInterval) -&gt; Void

public protocol RequestRetrier {
    func should(_ manager: SessionManager, retry request: Request, with error: Error, completion: @escaping RequestRetryCompletion)
}
</code></pre><p>它可以在 <code>Request</code> 遇到 <code>Error</code>的时候, 在指定的延迟之后重新发起. </p>
<pre><code>class OAuth2Handler: RequestAdapter, RequestRetrier {
    public func should(_ manager: SessionManager, retry request: Request, with error: Error, completion: RequestRetryCompletion) {
        if let response = request.task.response as? HTTPURLResponse, response.statusCode == 401 {
            completion(true, 1.0) // 1秒后重试
        } else {
            completion(false, 0.0) // 不重连
        }
    }
}

let sessionManager = SessionManager()
sessionManager.retrier = OAuth2Handler()

sessionManager.request(urlString).responseJSON { response in
    debugPrint(response)
}
</code></pre><p>重连器可以让你在检测到 <code>Request</code> 完成并且完成所有 <code>Validation</code> 检测之后再考虑是否重试. 当 <code>RequestAdapter</code> 和 <code>RequestRetrier</code> 一起使用的时候, 你可以给 OAuth1, OAuth2, Basic Auth 创建一套持续更新的校验系统(credential refresh systems), 甚至是快速重试的策略. 可能性是无限的. 想要获取更多关于这个话题的信息和例子, 请查看 README. </p>
<blockquote>
<p>译者注: 这里没太能理解作者的意思, 翻译得不好, 直接放原文:<br>When using both the <code>RequestAdapter</code> and <code>RequestRetrier</code> protocols together, you can create credential refresh systems for OAuth1, OAuth2, Basic Auth and even exponential backoff retry policies. </p>
<p>查看 <a href="https://github.com/Alamofire/Alamofire/pull/1391" target="_blank" rel="external">PR-1391</a> 以及 <a href="https://github.com/Alamofire/Alamofire/pull/1450" target="_blank" rel="external">PR-1450</a> 获取更多信息. </p>
</blockquote>
<h3 id="Task-Metrics"><a href="#Task-Metrics" class="headerlink" title="Task Metrics"></a>Task Metrics</h3><p>在 iOS, tvOS 10 和 macOS 10.12 里, 苹果引入了新的 [URLSessionTaskMetrics][13] API, task metrics 包含了一些 request 和 response 的统计信息, API 跟 Alamofire 的 <code>Timeline</code> 很像, 但提供了许多 Alamofire 里获取不到的统计信息. 我们对这些新的 API 特别兴奋, 但把这些全部都暴露到每一个 <code>Response</code> 类型里意味着这并不容易使用. </p>
<pre><code>   [13]: https://developer.apple.com/reference/foundation/urlsessiontaskmetrics
</code></pre><p>Alamofire.request(urlString).response { response in<br>            debugPrint(response.metrics)<br>    }</p>
<p>有一点很重要的是, 这些 API 只有在 iOS 和 tvOS 10+ 和 macOS 10.12+上才能使用. 所以它是依赖于运行设备的, 你可能需要做可行性检查. </p>
<pre><code>Alamofire.request(urlString).response { response in
    if #available(iOS 10.0, *) {
                debugPrint(response.metrics)
    }
}
</code></pre><blockquote>
<p>查看 <a href="https://github.com/Alamofire/Alamofire/pull/1492" target="_blank" rel="external">PR-1492</a> 获取更多信息. </p>
</blockquote>
<h2 id="Updated-Features-更新的功能"><a href="#Updated-Features-更新的功能" class="headerlink" title="Updated Features 更新的功能"></a>Updated Features 更新的功能</h2><p>Alamofire 4 加强了现有的功能并且加入了很多新功能. 这一章节主要是大概地过一遍功能的更新和使用方式. 如果想要获取更多相关信息, 请点进链接查看相关的 pull request. </p>
<h3 id="Errors-异常"><a href="#Errors-异常" class="headerlink" title="Errors 异常"></a>Errors 异常</h3><p>Alamofire 4 加入了全新的异常系统, 采用了提案 <a href="https://github.com/apple/swift-evolution/blob/master/proposals/0112-nserror-bridging.md" target="_blank" rel="external">SE-0112</a> 里提出的新模式. 新的异常系统主要围绕 <code>AFError</code>, 一个继承了 <code>Error</code> 的枚举类型, 包含四个主要的 case. </p>
<ul>
<li><p><code>.invalidURL(url: URLConvertible)</code> - 创建 <code>URL</code> 失败的时候返回一个 <code>URLConvertible</code> 类型的值 </p>
</li>
<li><p><code>.parameterEncodingFailed(reason: ParameterEncodingFailureReason)</code> - 当其中一个参数编码出错的时候就会抛出错误并返回 </p>
</li>
<li><p><code>.multipartEncodingFailed(reason: MultipartEncodingFailureReason)</code> - multipart 编码出错就会抛出错误并返回 </p>
</li>
<li><p><code>.responseValidationFailed(reason: ResponseValidationFailureReason)</code> - 当调用 <code>validate()</code> 抛出错误时捕获然后抛出到外部. </p>
</li>
<li><p><code>.responseSerializationFailed(reason: ResponseSerializationFailureReason)</code> - 返回的数据序列化出错时会抛出异常并返回. </p>
</li>
</ul>
<p>每一个 case 都包含了特定的异常理由, 并且异常理由又是另一个带有具体错误信息的枚举类型. 这会让 Alamofire 更容易识别出错误的来源和原因. </p>
<pre><code>Alamofire.request(urlString).responseJSON { response in
    guard case let .failure(error) = response.result else { return }

    if let error = error as? AFError {
        switch error {
        case .invalidURL(let url):
            print(&quot;无效 URL: \(url) - \(error.localizedDescription)&quot;)
        case .parameterEncodingFailed(let reason):
            print(&quot;参数编码失败: \(error.localizedDescription)&quot;)
            print(&quot;失败理由: \(reason)&quot;)
        case .multipartEncodingFailed(let reason):
            print(&quot;Multipart encoding 失败: \(error.localizedDescription)&quot;)
            print(&quot;失败理由: \(reason)&quot;)
        case .responseValidationFailed(let reason):
            print(&quot;Response 校验失败: \(error.localizedDescription)&quot;)
            print(&quot;失败理由: \(reason)&quot;)

            switch reason {
            case .dataFileNil, .dataFileReadFailed:
                print(&quot;无法读取下载文件&quot;)
            case .missingContentType(let acceptableContentTypes):
                print(&quot;文件类型不明: \(acceptableContentTypes)&quot;)
            case .unacceptableContentType(let acceptableContentTypes, let responseContentType):
                print(&quot;文件类型: \(responseContentType) 无法读取: \(acceptableContentTypes)&quot;)
            case .unacceptableStatusCode(let code):
                print(&quot;请求返回状态码出错: \(code)&quot;)
            }
        case .responseSerializationFailed(let reason):
            print(&quot;请求返回内容序列化失败: \(error.localizedDescription)&quot;)
            print(&quot;失败理由: \(reason)&quot;)
        }

        print(&quot;错误: \(error.underlyingError)&quot;)
    } else if let error = error as? URLError {
        print(&quot;URL 错误: \(error)&quot;)
    } else {
        print(&quot;未知错误: \(error)&quot;)
    }
}
</code></pre><p>新的设计给你的处理方式更多的自由, 可以在你需要的时候深入到最具体的 error. 这也会让原本要四处应对 <code>NSError</code> 的开发者更加轻松地完成工作. 在 Alamofire 里通过使用自定义的 <code>Error</code> 类型, 我们可以看到 <code>Result</code> 和 <code>Response</code> 的泛型参数缩减到了只有一个, 简化了返回数据序列化的逻辑. </p>
<blockquote>
<p>查看 <a href="https://github.com/Alamofire/Alamofire/pull/1419" target="_blank" rel="external">PR-1419</a> 获取更多信息. </p>
</blockquote>
<h3 id="Parameter-Encoding-Protocol-参数编码的协议"><a href="#Parameter-Encoding-Protocol-参数编码的协议" class="headerlink" title="Parameter Encoding Protocol 参数编码的协议"></a>Parameter Encoding Protocol 参数编码的协议</h3><p><code>ParameterEncoding</code> 枚举类型在过去两年很好地解决了问题. 但我们在 Alamofire 4 里想要定位的时候却感觉到了一些局限. </p>
<ul>
<li><p><code>.url</code> 总让人有点迷惑, 因为它是一个 HTTP 协议定义的地址 </p>
</li>
<li><p><code>.urlEncodedInURL</code> 跟 <code>.url</code> 总是会混淆起来, 让人分不清它们行为的区别 </p>
</li>
<li><p><code>.JSON</code> 和 <code>.PropertyList</code> 编码不能自定义编码格式或者写入的方式 </p>
</li>
<li><p><code>.Custom</code> 编码对于用户来说太难掌握 </p>
</li>
</ul>
<p>因为这些原因, 我们决定在 Alamofire 4 把这个枚举去掉! 现在, <code>ParameterEncoding</code> 变成了一个协议, 加入了 <code>Parameters</code> 的类型别名去创建你的参数字典, 并且通过遵守这个协议建立了三个编码结构体 <code>URLEncoding</code>, <code>JSONEncoding</code> 和 <code>PropertyList</code>. </p>
<pre><code>public typealias Parameters = [String: Any]

public protocol ParameterEncoding {
    func encode(_ urlRequest: URLRequestConvertible, with parameters: Parameters?) throws -&gt; URLRequest
}
</code></pre><h4 id="URL-Encoding-参数编码"><a href="#URL-Encoding-参数编码" class="headerlink" title="URL Encoding (参数编码)"></a>URL Encoding (参数编码)</h4><p>新的 <code>URLEncoding</code> 结构体包含了一个 <code>Destination</code> 枚举, 支持三种类型的目标编码 </p>
<ul>
<li><p><code>.methodDependent</code> - 对于 <code>GET</code>, <code>HEAD</code> 和 <code>DELETE</code> 方法使用 query 字符串, 而别的 HTTP 方法则会编码为 HTTP body. </p>
</li>
<li><p><code>.queryString</code> - 设置或者往现有的 queryString 里增加内容 </p>
</li>
<li><p><code>.httpBody</code> - 设置请求的 HTTP body 内容 </p>
</li>
</ul>
<p>这些目标编码格式会让你更容易控制 <code>URLRequest</code> 的参数编码方式. 创建请求依旧使用和之前一样的方式, 不管编码的形式怎样, 都会保持与之前一样的默认行为. </p>
<pre><code>let parameters: Parameters = [&quot;foo&quot;: &quot;bar&quot;]

Alamofire.request(urlString, parameters: parameters) // Encoding =&gt; URLEncoding(destination: .methodDependent)
Alamofire.request(urlString, parameters: parameters, encoding: URLEncoding(destination: .queryString))
Alamofire.request(urlString, parameters: parameters, encoding: URLEncoding(destination: .httpBody))

// Static convenience properties (we&#39;d like to encourage everyone to use this more concise form)
// 便利的静态属性 (我们想鼓励大家使用这种更简洁的形式)
Alamofire.request(urlString, parameters: parameters, encoding: URLEncoding.default)
Alamofire.request(urlString, parameters: parameters, encoding: URLEncoding.queryString)
Alamofire.request(urlString, parameters: parameters, encoding: URLEncoding.httpBody)
</code></pre><h4 id="JSON-Encoding-JSON-编码"><a href="#JSON-Encoding-JSON-编码" class="headerlink" title="JSON Encoding (JSON 编码)"></a>JSON Encoding (JSON 编码)</h4><p>新的 <code>JSONEncoding</code> 结构体开放了让你自定义 JSON 写入形式的接口. </p>
<pre><code>let parameters: Parameters = [&quot;foo&quot;: &quot;bar&quot;]

Alamofire.request(urlString, parameters: parameters, encoding: JSONEncoding(options: []))
Alamofire.request(urlString, parameters: parameters, encoding: JSONEncoding(options: .prettyPrinted))

// Static convenience properties (we&#39;d like to encourage everyone to use this more concise form)
// 便利的静态属性 (我们想鼓励大家使用这种更简洁的形式)
Alamofire.request(urlString, parameters: parameters, encoding: JSONEncoding.default)
Alamofire.request(urlString, parameters: parameters, encoding: JSONEncoding.prettyPrinted)
</code></pre><h4 id="Property-List-Encoding-属性列表编码"><a href="#Property-List-Encoding-属性列表编码" class="headerlink" title="Property List Encoding (属性列表编码)"></a>Property List Encoding (属性列表编码)</h4><p>新的 <code>PropertyListEncoding</code> 结构体允许自定义 plist 的格式和写入选项 </p>
<pre><code>let parameters: Parameters = [&quot;foo&quot;: &quot;bar&quot;]

Alamofire.request(urlString, parameters: parameters, encoding: PropertyListEncoding(format: .xml, options: 0))
Alamofire.request(urlString, parameters: parameters, encoding: PropertyListEncoding(format: .binary, options: 0))

// Static convenience properties (we&#39;d like to encourage everyone to use this more concise form)
// 便利的静态属性 (我们想鼓励大家使用这种更简洁的形式)
Alamofire.request(urlString, parameters: parameters, encoding: PropertyListEncoding.xml)
Alamofire.request(urlString, parameters: parameters, encoding: PropertyListEncoding.binary)
</code></pre><h4 id="Custom-Encoding-自定义编码"><a href="#Custom-Encoding-自定义编码" class="headerlink" title="Custom Encoding 自定义编码"></a>Custom Encoding 自定义编码</h4><p>建立一个自定义的 <code>ParameterEncoding</code> 只要遵守这个协议建立类型即可. 想要获取更多相关例子, 请查看下面的 README </p>
<blockquote>
<p>查看 <a href="https://github.com/Alamofire/Alamofire/pull/1465" target="_blank" rel="external">PR-1465</a> 获取更多信息 </p>
</blockquote>
<h3 id="Request-Subclasses-Request-的子类"><a href="#Request-Subclasses-Request-的子类" class="headerlink" title="Request Subclasses (Request 的子类)"></a>Request Subclasses (Request 的子类)</h3><p>在 Alamofire 4, <code>request</code>, <code>download</code>, <code>upload</code> 和 <code>stream</code> 的 API 不会再返回 <code>Request</code>, 他们会返回特定的 <code>Request</code> 子类. 有下面几个引导我们做出这个改变的现实原因和社区的疑问: </p>
<ul>
<li><p><strong>Progress:</strong> <code>progress</code> 方法的行为会在 upload 请求里会很容易让人迷惑. </p>
<ul>
<li><p><code>progress</code> 在一个 upload 请求里返回的是什么? 上传的进度? 还是返回内容的下载进度? </p>
</li>
<li><p>如果都返回, 那我们怎么区分他们, 在什么时候能知道是到底返回的是哪一个? </p>
</li>
</ul>
</li>
<li><p><strong>Response Serializers:</strong> 返回内容的序列化是为了 data 和 upload 请求设计的, donwload 和 stream 请求并不需要序列化. </p>
<ul>
<li><p>你要怎么才能在下载完成时获取到文件的地址? </p>
</li>
<li><p><code>responseData</code>, <code>responseString</code> 和 <code>responseJSON</code> 对于一个 donwload 请求来说意味着什么? stream 请求呢? </p>
</li>
</ul>
</li>
</ul>
<p>Alamofire 4 现在有四个 <code>Request</code> 的子类, 并且每个字类都有一些特有的 API. 这样就可以让每一个子类能够通过建立 extension 来定制特定类型的请求. </p>
<pre><code>open class Request {
    // 包含了共有的属性, 验证, 和状态方法
    // 遵守 CustomStringConvertible 和 CustomDebugStringConvertible
}

open class DataRequest: Request {
    // 包含了数据流(不要跟 StreamRequest 混淆)和下载进度的方法
}

open class DownloadRequest: Request {
    // 包含了下载位置和选项, 已下载的数据以及进度方法
}

open class UploadRequest: DataRequest {
        // 继承了所有 DataRequest 的方法, 并且包含了上传进度的方法
}

open class StreamRequest: Request {
        // 只继承了 Request, 目前暂时没有任何自定义的 API
}
</code></pre><p>通过这样的切分, Alamofire 现在可以为每一个类型的请求自定义相关的 API. 这会覆盖到所有可能的需求, 但让我们花点时间来仔细了解一下这会如何改变进度汇报和下载地址. </p>
<blockquote>
<p>查看 <a href="https://github.com/Alamofire/Alamofire/pull/1455" target="_blank" rel="external">PR-1455</a> 获取更多信息 </p>
</blockquote>
<h4 id="Download-and-Upload-Progress-下载和上传你进度"><a href="#Download-and-Upload-Progress-下载和上传你进度" class="headerlink" title="Download and Upload Progress (下载和上传你进度)"></a>Download and Upload Progress (下载和上传你进度)</h4><p>Data, download 和 upload 请求的进度汇报系统完全重新设计了一遍. 每一个请求类型都包含有一个闭包, 每当进度更新的时候, 就会调用闭包并且传入 <code>Progress</code> 类型的参数. 这个闭包会在指定的队列被调用, 默认为主队列. </p>
<p><strong>Data Request 进度</strong></p>
<pre><code>Alamofire.request(urlString)
    .downloadProgress { progress in
        // 默认在主队列调用
        print(&quot;下载进度: \(progress.fractionCompleted)&quot;)
    }
    .responseJSON { response in
        debugPrint(response)
    }
</code></pre><p><strong>Download Request 进度</strong></p>
<pre><code>Alamofire.download(urlString, to: destination)
    .downloadProgress(queue: DispatchQueue.global(qos: .utility)) { progress in
        // 在 .utility 队列里调用
        print(&quot;下载进度: \(progress.fractionCompleted)&quot;)
    }
    .responseJSON { response in
        debugPrint(response)
    }
</code></pre><p><strong>Upload Request 进度</strong></p>
<pre><code>Alamofire.upload(data, to: urlString, withMethod: .post)
    .uploadProgress { progress in
        // 默认在主队列调用
        print(&quot;上传进度: \(progress.fractionCompleted)&quot;)
    }
    .downloadProgress { progress in
        // 默认在主队列调用
        print(&quot;下载进度: \(progress.fractionCompleted)&quot;)
    }
    .responseData { response in
        debugPrint(response)
    }
</code></pre><p>现在很容易就可以区分开 upload request 里的上传和下载进度. </p>
<blockquote>
<p>查看 <a href="https://github.com/Alamofire/Alamofire/pull/1455" target="_blank" rel="external">PR-1455</a> 获取更多信息. </p>
</blockquote>
<h4 id="Download-File-Destinations-文件下载地址"><a href="#Download-File-Destinations-文件下载地址" class="headerlink" title="Download File Destinations 文件下载地址"></a>Download File Destinations 文件下载地址</h4><p>在 Alamofire 3.x, 顺利完成的 download requests 总是会在 <code>destination</code> 回调里把临时文件移动到最终目标文件夹里. 这很方便, 但也同时带来了几个限制: </p>
<ul>
<li><p><code>Forced</code> - API 强制你去提供一个 destination 闭包来移动文件, 即使你验证过后不想移动文件了. </p>
</li>
<li><p><code>Limiting</code> - 没有任何方式可以去调整文件系统移动文件的优先级别. </p>
<ul>
<li><p>如果你需要在移动到目标文件夹之前删掉之前存在的文件呢? </p>
</li>
<li><p>如果你需要在移动临时文件之前创建目录呢? </p>
</li>
</ul>
</li>
</ul>
<p>这些限制都会在 Alamofire 4 里都不复存在. 首先是 optional 的 destination 闭包. 现在, <code>destination</code> 默认为 nil, 意味着文件系统不会移动文件, 并且会返回临时文件的 URL. </p>
<pre><code>Alamofire.download(urlString).responseData { response in
    print(&quot;临时文件的 URL: \(response.temporaryURL)&quot;)
}
</code></pre><blockquote>
<p>我们将会恢复 <code>DownloadResponse</code> 类型, 更多详细信息请查看 Reponse Serializers 章节. </p>
</blockquote>
<h4 id="Download-Options-下载选项"><a href="#Download-Options-下载选项" class="headerlink" title="Download Options 下载选项"></a>Download Options 下载选项</h4><p>另外一个主要的改变是 destination 闭包里面加上了下载选项, 让你可以进行更多文件系统操作. 为了达到目的, 我们建立了一个 <code>DownloadOptions</code> 类型并且添加到 <code>DownloadFileDestination</code> 闭包里. </p>
<pre><code>public typealias DownloadFileDestination = (
    _ temporaryURL: URL,
    _ response: HTTPURLResponse)
    -&gt; (destinationURL: URL, options: DownloadOptions)
</code></pre><p>现阶段支持的两个 <code>DownloadOptions</code> 是: </p>
<ul>
<li><p><code>.createIntermediateDirectories</code> - 如果有指定的下载地址的话, 会为下载地址创建相应的目录 </p>
</li>
<li><p><code>.removePreviousFile</code> - 如果有指定的下载地址的话, 会自动替代掉同名文件 </p>
</li>
</ul>
<p>这两个选项可以像下面这样用: </p>
<pre><code>let destination: DownloadRequest.DownloadFileDestination = { _, _ in
    return (fileURL, [.removePreviousFile, .createIntermediateDirectories])
}

Alamofire.download(urlString, to: destination).response { response in
    debugPrint(response)
}
</code></pre><p>如果一个异常在文件系统操作时抛出的话, <code>DownloadResponse</code> 的 <code>error</code> 就会是 <code>URLError</code> 类型. </p>
<blockquote>
<p>查看 <a href="https://github.com/Alamofire/Alamofire/pull/1462" target="_blank" rel="external">PR-1462</a> 获取更多信息. </p>
</blockquote>
<h3 id="Response-Validation-数据验证"><a href="#Response-Validation-数据验证" class="headerlink" title="Response Validation 数据验证"></a>Response Validation 数据验证</h3><p>在 Alamofire 4 里有几个可以加强数据验证系统的地方. 包括了: </p>
<ul>
<li><p><code>Validation</code> 回调闭包里传入的 <code>data</code></p>
</li>
<li><p><code>Request</code> 子类可以自定义数据验证系统, 例如 download 请求里的 <code>temporaryURL</code> 和 <code>destinationURL</code> 暴露到了回调闭包里 </p>
</li>
</ul>
<p>通过继承 <code>Request</code>, 每一个 <code>Request</code> 的子类都可以自定义一套数据验证的闭包(typealias)和请求的 API. </p>
<h4 id="Data-Request-数据请求"><a href="#Data-Request-数据请求" class="headerlink" title="Data Request 数据请求"></a>Data Request 数据请求</h4><p><code>DataRequest</code> (<code>UploadRequest</code> 的父类)暴露出来的 <code>Validation</code> 目前是这样定义的: </p>
<pre><code>extension DataRequest {
    public typealias Validation = (URLRequest?, HTTPURLResponse, Data?) -&gt; ValidationResult
}
</code></pre><p>直接在闭包里把 <code>Data?</code> 暴露出来, 你就不需要再给 <code>Request</code> 增加一个 extension 去访问这个属性了. 现在你可以直接这样子做: </p>
<pre><code>Alamofire.request(urlString)
    .validate { request, response, data in
        guard let data = data else { return .failure(customError) }

        // 1) 验证返回的数据保证接下来的操作不会出错
        // 2) 如果验证失败, 你可以把错误信息返回出去, 甚至加上自定义的 error

        return .success
    }
    .response { response in
        debugPrint(response)
    }
</code></pre><h4 id="Download-Request-下载请求"><a href="#Download-Request-下载请求" class="headerlink" title="Download Request 下载请求"></a>Download Request 下载请求</h4><p><code>DownloadRequest</code> 里的 <code>Validation</code> 闭包跟 <code>DataRequest</code> 里的很像, 但为了下载任务做了更多的定制. </p>
<pre><code>extension DownloadRequest {
        public typealias Validation = (
            _ request: URLRequest?,
            _ response: HTTPURLResponse,
            _ temporaryURL: URL?,
            _ destinationURL: URL?)
            -&gt; ValidationResult
}
</code></pre><p><code>temporaryURL</code> 和 <code>destinationURL</code> 参数现在让你可以在闭包内直接获取到服务器返回的数据. 这可以让你校验下载好的文件, 在有需要的时候可以抛出一个自定义的错误. </p>
<pre><code>Alamofire.download(urlString)
    .validate { request, response, temporaryURL, destinationURL in
        guard let fileURL = temporaryURL else { return .failure(customError) }

        do {
            let _ = try Data(contentsOf: fileURL)
            return .success
        } catch {
            return .failure(customError)
        }
    }
    .response { response in
        debugPrint(response)
    }
</code></pre><p>通过直接在闭包里暴露服务器返回的数据, 这里面的所有异常都可以在 <code>Validation</code> 闭包里捕获到, 并且可以自定义错误信息. 如果这里获取到的信息和 response 序列化回调里一样的话, response 可以用来处理错误信息而不是简单地把逻辑赋值过来. 具体的例子, 请查看下面的 README. </p>
<blockquote>
<p>查看 <a href="https://github.com/Alamofire/Alamofire/pull/1461" target="_blank" rel="external">PR-1461</a> 获取更多信息. </p>
</blockquote>
<h3 id="Response-Serializers-返回数据序列化"><a href="#Response-Serializers-返回数据序列化" class="headerlink" title="Response Serializers 返回数据序列化"></a>Response Serializers 返回数据序列化</h3><p>Alamofire 3.x 里的序列化系统有这么几个限制: </p>
<ul>
<li><p>序列化的 API 可以用在 download 和 stream 请求里, 但却会导致未知的行为发生 </p>
<ul>
<li><p>怎么在下载成功时获取到文件 URL? </p>
</li>
<li><p><code>responseData</code>, <code>responseString</code> 或者 <code>responseJSON</code> 会在 donwload 请求里产生怎样的行为? stream 请求呢? </p>
</li>
</ul>
</li>
<li><p><code>response</code> API 返回四个参数而不是封装到一个 <code>Response</code> 类型里. </p>
<ul>
<li><p>最大的问题是 API 任何改变都会导致前面行为的变化. </p>
</li>
<li><p>在序列化和反序列化的 API 之间切换会让人迷惑, 同时导致难以 debug 的编译错误. </p>
</li>
</ul>
</li>
</ul>
<p>就像你看到的, Alamofire 3.x 的这一套序列化系统有这么多限制. 所以, 在 Alamofire 4里, <code>Request</code> 类型首先被切分到各个子类里, 这么做给自定义序列化方式, 和自定义 API 留下了空间. 在我们更深入了解序列化方式之前, 我们先了解一下新的 <code>Response</code> 类型 </p>
<h4 id="Default-Data-Response"><a href="#Default-Data-Response" class="headerlink" title="Default Data Response"></a>Default Data Response</h4><p><code>DefaultDataResponse</code> 代表了未被序列化的服务器返回数据. Alamofire 没有做任何处理过的, 只是纯粹地从 <code>SessionDelegate</code> 里获取信息并且包装在一个结构体里面返回. </p>
<pre><code>public struct DefaultDataResponse {
    public let request: URLRequest?
    public let response: HTTPURLResponse?
    public let data: Data?
    public let error: Error?
    public var metrics: URLSessionTaskMetrics? { return _metrics as? URLSessionTaskMetrics }
}
</code></pre><p>下面是你会获得 <code>DataRequest.response</code> 的一种返回. </p>
<pre><code>Alamofire.request(urlString).response { response in
    debugPrint(response)
}

Alamofire.upload(file, to: urlString).response { response in
    debugPrint(response)
}
</code></pre><h4 id="Data-Response"><a href="#Data-Response" class="headerlink" title="Data Response"></a>Data Response</h4><p>泛型 <code>DataResponse</code> 类型跟 Alamofire 3.x 里的 <code>Response</code> 一样, 但内部重构并且包含了新的 <code>metrics</code> 变量. </p>
<pre><code>public struct DataResponse&lt;Value&gt; {
    public let request: URLRequest?
    public let response: HTTPURLResponse?
    public let data: Data?
    public let result: Result&lt;Value&gt;
    public let timeline: Timeline
        public var metrics: URLSessionTaskMetrics? { return _metrics as? URLSessionTaskMetrics }
}
</code></pre><p>使用 <code>DataRequest</code> 和 <code>UploadRequest</code>, 你可以像之前(3.x)那样使用 response 序列化的 API </p>
<pre><code>Alamofire.request(urlString).responseJSON { response in
    debugPrint(response)
    print(response.result.isSuccess)
}

Alamofire.upload(fileURL, to: urlString).responseData { response in
    debugPrint(response)
    print(response.result.isSuccess)
}
</code></pre><h4 id="Default-Download-Response-默认下载请求的-Response-类型"><a href="#Default-Download-Response-默认下载请求的-Response-类型" class="headerlink" title="Default Download Response 默认下载请求的 Response 类型"></a>Default Download Response 默认下载请求的 Response 类型</h4><p>因为 donwload 请求跟 data 和 upload 请求很不一样, 所以 Alamofire 4 包含了自定义的 donwload <code>Response</code> 类型. <code>DefaultDownloadResponse</code> 类型代表未序列化的返回数据, 包含了所有 <code>SessionDelegate</code> 信息的结构体. </p>
<pre><code>public struct DefaultDownloadResponse {
    public let request: URLRequest?
    public let response: HTTPURLResponse?
    public let temporaryURL: URL?
    public let destinationURL: URL?
    public let resumeData: Data?
    public let error: Error?
        public var metrics: URLSessionTaskMetrics? { return _metrics as? URLSessionTaskMetrics }
}
</code></pre><p><code>DefaultDownloadResponse</code> 类型在使用新的 <code>DownloadRequest.response</code> API 时就会被返回. </p>
<pre><code>Alamofire.download(urlString).response { response in
    debugPrint(response)
    print(response.temporaryURL)
}
</code></pre><h4 id="Download-Response"><a href="#Download-Response" class="headerlink" title="Download Response"></a>Download Response</h4><p>新的泛型 <code>DownloadResponse</code> 跟 <code>DataResponse</code> 很像, 但包含了 download 请求特有的信息. <code>DownloadResponse</code> 类型在使用 <code>DownloadRequest</code> 时就会被返回. 这些新的 API 同样也适用于 <code>DataRequest</code>, 一样能够获取临时目录的 url 和目标目录的 url. </p>
<pre><code>Alamofire.download(urlString, to: destination)
    .responseData { response in
        debugPrint(response)
    }
    .responseString { response in
        debugPrint(response)
    }
    .responseJSON { response in
        debugPrint(response)
    }
    .responsePropertyList { response in
        debugPrint(response)
    }
</code></pre><p>新的序列化 API 让文件下载和序列化更加容易完成. </p>
<h4 id="Custom-Response-Serializers-自定义序列化"><a href="#Custom-Response-Serializers-自定义序列化" class="headerlink" title="Custom Response Serializers 自定义序列化"></a>Custom Response Serializers 自定义序列化</h4><p>如果你已经创建了自定义的序列化, 你也许会想要拓展支持 data 和 download 请求, 就像我们在 Alamofire 序列化 API 里面做的一样.. 如果你决定这么做, 可以仔细看一下 Alamofire 怎么在几种 <code>Request</code> 类型里共享序列化方法, 然后把实现写到 <code>Request</code> 里就可以了. 这可以让我们 DRY up 逻辑并且避免重复的代码.(Don’t repeat yourself) </p>
<blockquote>
<p>查看 <a href="https://github.com/Alamofire/Alamofire/pull/1457" target="_blank" rel="external">PR-1457</a> 获取更多信息. </p>
</blockquote>

           
         <style type="text/css">
.hljs-comment,
.hljs-quote {
  color: #999999;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
  color: #f2777a;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
  color: #f99157;
}

/* Tomorrow Yellow */
.hljs-attribute {
  color: #ffcc66;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
  color: #99cc99;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
  color: #6699cc;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
  color: #cc99cc;
}

.hljs {
  display: block;
  overflow-x: auto;
  background: #2d2d2d !important;
  color: #cccccc !important;
  padding: 1em !important;
}

pre{
    background: #2d2d2d !important;
}

.hljs-emphasis {
  font-style: italic;
}

.hljs-strong {
  font-weight: bold;
}
</style>
<script type="text/javascript">
// $(function(){
// 	//代码高亮自定义
// 	$("code").each(function(){
// 		$(this).html("<ul><li>" + $(this).html().replace(/\n/g,"\n</li><li>") +"\n</li></ul>");
// 	});
// });
</script>

<style type="text/css">
/*.hljs {
	border: 0;
	font-family: "Consulas", "Courier New", Courier, mono, serif;
	font-size: 12px;
	background: #eee !important;
	display: block;
	padding: 1px;
	margin: 0;
	width: 100%;
	font-weight: 200;
	color: #333;
	white-space: pre-wrap
}*/
/*.hljs ul {
	list-style: decimal;
	background-color: #fff;
	margin: 0px 0px 0 0px !important;
	padding: 0px;
}*/
/*.hljs ul li {
	list-style: decimal-leading-zero;
	border-left: 1px solid #ddd !important;
	background: #fff;
	padding: 5px!important;
	margin: 0 !important;
  width: 20px !important;
	line-height: 14px;
	word-break: break-all;
	word-wrap: break-word;
}*/
/*.hljs ul li:nth-of-type(even) {
	background-color: #fcfcfc;
	color: inherit;
}*/
</style>
<script src="https://cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
       <script >hljs.initHighlightingOnLoad();</script>  
         
    
             
           <style type="text/css">
           #rewardButton {
    cursor: pointer;
    border: 0;
    outline: 0;
    border-radius: 100%;
    padding: 0;
    margin: 0;
    letter-spacing: normal;
    text-transform: none;
    text-indent: 0px;
    text-shadow: none;
}
#rewardButton span {
    display: inline-block;
    width: 80px;
    height: 35px;
    border-radius: 5px;
    padding-top: 5px;
    color: #fff;
    font-weight: 400;
    font-style: normal;
    font-variant: normal;
    font-stretch: normal;
    font-size: 18px;
    font-family: "Microsoft Yahei";
    background: #F44336;
}
#rewardButton span:hover{
    background: #F7877F;
}
#QR{
    padding-top:20px;
}
#QR a{
    border:0;
}
#QR img{
    width: 180px;
    max-width: 100%;
    display: inline-block;
    margin: 0.8em 2em 0 2em;
}
#wechat:hover p{
    animation: roll 0.1s infinite linear;
    -webkit-animation: roll 0.1s infinite linear;
    -moz-animation: roll 0.1s infinite linear;
}
#alipay:hover p{
    animation: roll 0.1s infinite linear;
    -webkit-animation: roll 0.1s infinite linear;
    -moz-animation: roll 0.1s infinite linear;
}
@keyframes roll {
    from {
      transform(rotateZ(30deg));
    }
    to {
      transform(rotateZ(-30deg));
    }
}

           </style>
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/uploads/wechat.JPG" alt="人不如故 WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/uploads/ali.JPG" alt="人不如故 Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>
           


     
    
    
</div>


                

                <!-- Post Comments -->
                
                    




    <!-- 使用 DISQUS -->
    <div id="disqus-comment">
        <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
        this.page.url = 'https://wangyu1997.github.io/2017/06/14/Alamofire 中文使用指南/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'https://wangyu1997.github.io/2017/06/14/Alamofire 中文使用指南/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    queue.offer(function() {
            (function() { // DON'T EDIT BELOW THIS LINE
                var d = document;
                var s = d.createElement('script');
                s.src = '//https-wangyu1997-github-io.disqus.com/embed.js';
                s.setAttribute('data-timestamp', + new Date());
                (d.head || d.body).appendChild(s);
            })();
        });
</script>

    </div>
    <style>
        #disqus-comment{
            background-color: #eee;
            padding: 2pc;
        }
    </style>




                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/06/21/Centos LNMP/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/06/14/七牛云储存/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="人不如故's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        wangyu19970819@gmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
             
                    <a href="mailto:wangyu19970819@gmail.com" target="_blank" title="Email Me">
               
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
                <li>
             
                    <a href="/about" target="_self" title="关于">
              
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">person</i>
                        
                        关于
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    


    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/Android/">Android<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/JavaWeb/">JavaWeb<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/Python/">Python<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/categories/iOS/">iOS<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/categories/machine-learning/">machine learning<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/操作系统/">操作系统<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/杂记/">杂记<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/那些年倒腾过的服务器/">那些年倒腾过的服务器<span class="sidebar_archives-count">3</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="/links" title="小伙伴们">
                
                    <i class="material-icons sidebar-material-icons">group</i>
                
                小伙伴们
            </a>
        </li>
        
    
        <li>
            <a href="/tags" title="标签">
                
                    <i class="material-icons sidebar-material-icons">loyalty</i>
                
                标签
            </a>
        </li>
        
    

            <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/09/">九月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/08/">八月 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/07/">七月 2017<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/06/">六月 2017<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/05/">五月 2017<span class="sidebar_archives-count">3</span></a>
            </ul>
        </li>
        
    

          <!-- rss -->
    
        <li id="sidebar-first-li">
            <a href="/gallery" target="_self">
                
                    <i class="material-icons sidebar-material-icons">favorite</i>
                
                情愫
            </a>
        </li>
        
    

      <!-- board -->
    
        <li id="sidebar-first-li">
            <a href="/board" target="_self">
                
                    <i class="material-icons sidebar-material-icons">question_answer</i>
                
                留言板
            </a>
        </li>
        
    

      <!-- rss -->
    
        <li id="sidebar-first-li">
            <a href="/atom.xml" target="_blank">
                
                    <i class="material-icons sidebar-material-icons">cast_connected</i>
                
                RSS订阅
            </a>
        </li>
        
            <li class="divider"></li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">20</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    
 
  <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
   <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  
 


                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/renburugu" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-facebook.svg);">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/wangyu1997" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.svg);">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;人不如故
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Follow me on - <a href="https://www.facebook.com/renburugu" target="_blank" class="footer-develop-a">FaceTime</a></div>
                <div class="footer-develop-div">Fork me on - <a href="https://github.com/wangyu1997" target="_blank" class="footer-develop-a">GitHub</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->

    <script src="/js/lazyload.min.js"></script>
    <script src="/js/js.min.js"></script>



    <script src="/js/nprogress.js"></script>


<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>



    
        <script src="/js/smoothscroll.js"></script>
    





    <!-- Busuanzi -->
    <script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>







    <!-- 使用 DISQUS js 代码 -->
    <script id="dsq-count-scr" src="//https-wangyu1997-github-io.disqus.com/count.js" async></script>





<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script>
    <!-- Offer LazyLoad -->
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    <!-- Start Queue -->
    $(document).ready(function(){
        setTimeout(function(){
            setInterval(function(){
                queue.execNext();
            },200);
        },3000);
    });
</script>

                </main>
            </div>
        </body>
    
</html>
